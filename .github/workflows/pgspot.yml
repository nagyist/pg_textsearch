name: pgspot Security Check

# NOTE: PR checks are consolidated in ci.yml. This workflow runs on main only.
on:
  push:
    branches: [ main ]
    paths:
      - 'sql/**'
      - '.github/workflows/pgspot.yml'

jobs:
  pgspot:
    name: Check Extension SQL
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install pgspot
      run: pip install pgspot

    - name: Run pgspot
      run: |
        # Check extension SQL files
        # Ignore PS017 (unqualified object reference) - false positives for
        # type/operator definitions that reference types being created
        # Ignore PS002 (CREATE OR REPLACE) in upgrade scripts - required to
        # update function probin when the versioned library name changes
        has_errors=0
        for sql_file in sql/pg_textsearch--*.sql; do
          echo "Checking $sql_file"
          ignore_flags="--ignore PS017"
          if [[ "$sql_file" == *--*--*.sql ]]; then
            ignore_flags="$ignore_flags --ignore PS002"
          fi
          if ! pgspot $ignore_flags "$sql_file"; then
            has_errors=1
          fi
        done
        exit $has_errors
